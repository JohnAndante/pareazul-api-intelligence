---
alwaysApply: true
description: Arquitetura do Projeto - Pare Azul API Intelligence
---

# ğŸ—ï¸ Arquitetura do Projeto - Pare Azul API Intelligence

## ğŸ“‹ Resumo Executivo

Este documento descreve a arquitetura completa do sistema de assistente IA conversacional para o Pare Azul. O projeto segue padrÃµes de Clean Architecture + Domain-Driven Design com excelente separaÃ§Ã£o de responsabilidades e type safety robusto.

## ğŸ¯ PadrÃ£o Arquitetural

- **Clean Architecture + Domain-Driven Design**
- **SeparaÃ§Ã£o clara de camadas** (Controllers â†’ Services â†’ Repositories)
- **InversÃ£o de dependÃªncias** bem implementada
- **TypeScript** com tipagem forte em toda a aplicaÃ§Ã£o
- **Modularidade** excelente com responsabilidades bem definidas

## ğŸ“ Estrutura de DiretÃ³rios

```
src/
â”œâ”€â”€ ğŸ¤– agents/                  # Agentes IA especializados
â”‚   â””â”€â”€ assistant/                      # Agente principal de conversaÃ§Ã£o
â”‚       â”œâ”€â”€ agent.ts                    # ConfiguraÃ§Ã£o do LangChain
â”‚       â”œâ”€â”€ index.ts                    # OrquestraÃ§Ã£o de mensagens
â”‚       â”œâ”€â”€ prompt.ts                   # Sistema de prompts dinÃ¢micos
â”‚       â””â”€â”€ schemas.ts                  # Schemas de validaÃ§Ã£o
â”œâ”€â”€ ğŸ’¼ services/                # LÃ³gica de negÃ³cio
â”‚   â”œâ”€â”€ activation.service.ts           # LÃ³gica de ativaÃ§Ãµes
â”‚   â”œâ”€â”€ memory.service.ts               # Gerenciamento de memÃ³ria
â”‚   â””â”€â”€ session.service.ts              # Gerenciamento de sessÃµes
â”œâ”€â”€ ğŸ—ƒï¸ repositories/            # Acesso a dados (Repository Pattern)
â”‚   â”œâ”€â”€ base.repository.ts              # Repository base
â”‚   â”œâ”€â”€ chat.repository.ts              # SessÃµes de chat
â”‚   â””â”€â”€ message.repository.ts           # Mensagens
â”œâ”€â”€ ğŸ›£ï¸ routes/                  # Roteamento da API
â”‚   â”œâ”€â”€ index.ts                        # Roteamento principal
â”‚   â””â”€â”€ assistant.route.ts              # Rotas do assistente
â”œâ”€â”€ ğŸ® controllers/             # Controladores HTTP
â”‚   â””â”€â”€ assistant.controller.ts         # Controller principal
â”œâ”€â”€ ğŸ›¡ï¸ middleware/              # Middlewares de seguranÃ§a e validaÃ§Ã£o
â”‚   â”œâ”€â”€ auth.middleware.ts              # AutenticaÃ§Ã£o
â”‚   â”œâ”€â”€ validation.middleware.ts        # ValidaÃ§Ã£o Zod
â”‚   â”œâ”€â”€ rate-limit.middleware.ts        # Rate limiting
â”‚   â”œâ”€â”€ security.middleware.ts          # Headers de seguranÃ§a
â”‚   â”œâ”€â”€ cors.middleware.ts              # CORS
â”‚   â””â”€â”€ error-handler.middleware.ts     # Tratamento de erros
â”œâ”€â”€ ğŸ”§ utils/                   # UtilitÃ¡rios e helpers
â”‚   â”œâ”€â”€ logger.util.ts                  # Sistema de logging
â”‚   â”œâ”€â”€ vector-search.util.ts           # Busca vetorial
â”‚   â”œâ”€â”€ validation.util.ts              # UtilitÃ¡rios de validaÃ§Ã£o
â”‚   â”œâ”€â”€ crypto.util.ts                  # Criptografia
â”‚   â”œâ”€â”€ redis.util.ts                   # UtilitÃ¡rios Redis
â”‚   â””â”€â”€ activation.utils.ts             # UtilitÃ¡rios de ativaÃ§Ã£o
â”œâ”€â”€ ğŸ“ types/                   # DefiniÃ§Ãµes TypeScript
â”‚   â”œâ”€â”€ chat.types.ts                   # Tipos de chat
â”‚   â”œâ”€â”€ activation.types.ts             # Tipos de ativaÃ§Ã£o
â”‚   â”œâ”€â”€ vehicle.types.ts                # Tipos de veÃ­culos
â”‚   â”œâ”€â”€ prefecture.types.ts             # Tipos de prefeitura
â”‚   â””â”€â”€ session.types.ts                # Tipos de sessÃ£o
â”œâ”€â”€ âš™ï¸ config/                  # ConfiguraÃ§Ãµes do sistema
â”‚   â”œâ”€â”€ environment.config.ts           # VariÃ¡veis de ambiente
â”‚   â”œâ”€â”€ database.config.ts              # ConfiguraÃ§Ã£o Supabase
â”‚   â””â”€â”€ redis.config.ts                 # ConfiguraÃ§Ã£o Redis
â”œâ”€â”€ ğŸ› ï¸ tools/                   # Tools do LangChain
â”‚   â”œâ”€â”€ index.ts                        # AgregaÃ§Ã£o de tools
â”‚   â”œâ”€â”€ activation.tools.ts             # Tools de ativaÃ§Ã£o
â”‚   â”œâ”€â”€ database.tool.ts                # Tools de banco
â”‚   â””â”€â”€ faq.tool.ts                     # Tool de FAQ
â”œâ”€â”€ ğŸ“Š api/                     # IntegraÃ§Ãµes com APIs externas
â”‚   â”œâ”€â”€ activation.api.ts               # API de ativaÃ§Ãµes
â”‚   â”œâ”€â”€ vehicle.api.ts                  # API de veÃ­culos
â”‚   â””â”€â”€ prefecture.api.ts               # API de prefeitura
â”œâ”€â”€ âœ… validators/              # Schemas de validaÃ§Ã£o Zod
â”‚   â”œâ”€â”€ activation.validator.ts         # ValidaÃ§Ã£o de ativaÃ§Ãµes
â”‚   â”œâ”€â”€ user.validator.ts               # ValidaÃ§Ã£o de usuÃ¡rios
â”‚   â”œâ”€â”€ vehicle.validator.ts            # ValidaÃ§Ã£o de veÃ­culos
â”‚   â”œâ”€â”€ prefecture.validator.ts         # ValidaÃ§Ã£o de prefeitura
â”‚   â””â”€â”€ notification.validator.ts       # ValidaÃ§Ã£o de notificaÃ§Ãµes
â””â”€â”€ ğŸ“œ scripts/                 # Scripts utilitÃ¡rios
    â”œâ”€â”€ populate-faq.ts                 # PopulaÃ§Ã£o do FAQ
    â””â”€â”€ faq-data.ts                     # Dados do FAQ
```

## ğŸ”„ Fluxo de ExecuÃ§Ã£o

### 1. Entrada da RequisiÃ§Ã£o

```
HTTP Request â†’ Express Router â†’ Middleware Stack â†’ Controller
```

### 2. Processamento Principal

```
Controller â†’ Agent Index â†’ Session Service â†’ Memory Service â†’ AI Agent
```

### 3. ExecuÃ§Ã£o do Agente IA

```
AI Agent â†’ LangChain â†’ Tools â†’ External APIs â†’ Response
```

### 4. PersistÃªncia e Cache

```
Memory Service â†’ Redis (Cache) + Supabase (Persistence)
```

## ğŸ› ï¸ Sistema de Tools

### Estrutura das Tools

- **LangChain DynamicStructuredTool**: PadrÃ£o consistente
- **Zod Schemas**: ValidaÃ§Ã£o de entrada tipada
- **SeparaÃ§Ã£o por domÃ­nio**: Activation, Database, FAQ
- **Error Handling**: Tratamento robusto de erros

### Tools DisponÃ­veis

1. **`faq_search`**: Busca vetorial no conhecimento
2. **`get_user_info`**: InformaÃ§Ãµes do usuÃ¡rio
3. **`get_message_history`**: HistÃ³rico de conversas
4. **`get_session_status`**: Status da sessÃ£o
5. **`checkVehicleCurrentActivations`**: Verificar ativaÃ§Ãµes
6. **`registerVehicleActivation`**: Registrar ativaÃ§Ãµes

## ğŸ’¼ Camada de ServiÃ§os

### MemoryService

- **Responsabilidade**: Gerenciamento de cache e buffer de memÃ³ria
- **Tecnologias**: Redis + Supabase
- **PadrÃµes**: Singleton, Cache-Aside Pattern

### SessionService

- **Responsabilidade**: Gerenciamento do ciclo de vida das sessÃµes
- **LÃ³gica**: ReplicaÃ§Ã£o do fluxo n8n
- **Features**: Auto-inativaÃ§Ã£o, sessÃµes ativas Ãºnicas

### ActivationService

- **Responsabilidade**: LÃ³gica de negÃ³cio para ativaÃ§Ãµes de veÃ­culos
- **IntegraÃ§Ãµes**: APIs externas do Pareazul
- **ValidaÃ§Ãµes**: Regras de negÃ³cio complexas

## ğŸ” Sistema de ValidaÃ§Ã£o e AutenticaÃ§Ã£o

### ValidaÃ§Ã£o (Zod)

- **Schemas centralizados** em `validators/`
- **ValidaÃ§Ã£o em tempo de execuÃ§Ã£o**
- **Type safety** automÃ¡tico
- **Mensagens de erro** padronizadas

### AutenticaÃ§Ã£o

- **HeaderAuth** compatÃ­vel com n8n
- **Middleware flexÃ­vel** com configuraÃ§Ãµes
- **Suporte a Bearer tokens**
- **ValidaÃ§Ã£o opcional/obrigatÃ³ria**

### Middleware Stack

1. **CORS** â†’ **Security** â†’ **Rate Limiting** â†’ **Auth** â†’ **Validation** â†’ **Controller**

## ğŸ§  Sistema de MemÃ³ria HÃ­brida

### Redis (Cache Layer)

- **Session Cache**: Metadados de sessÃ£o
- **Memory Buffer**: Mensagens recentes
- **TTL configurÃ¡vel**: 6 horas padrÃ£o
- **Fallback graceful**: Continua funcionando sem Redis

### Supabase (Persistence Layer)

- **Chat Sessions**: SessÃµes persistentes
- **Messages**: HistÃ³rico completo
- **Vector Search**: FAQ com embeddings
- **Admin Client**: OperaÃ§Ãµes privilegiadas

## ğŸ¤– ImplementaÃ§Ã£o do Agente IA

### LangChain Integration

- **OpenAI GPT-4o-mini**: Modelo principal
- **Temperature 0.3**: Respostas balanceadas
- **Max Iterations 12**: Previne loops infinitos
- **Early Stopping**: OtimizaÃ§Ã£o de performance

### Prompt Engineering

- **Sistema de prompt dinÃ¢mico** baseado no payload
- **InstruÃ§Ãµes claras** para uso das tools
- **Contexto de sessÃ£o** preservado
- **Exemplos prÃ¡ticos** de interaÃ§Ã£o

### Tool Integration

- **SeleÃ§Ã£o automÃ¡tica** de tools baseada no contexto
- **ValidaÃ§Ã£o de entrada** antes da execuÃ§Ã£o
- **Error handling** robusto
- **Logging detalhado** para debugging

## ğŸ› ï¸ Tecnologias e DependÃªncias

### Runtime & Framework

- **Bun**: Runtime moderno e rÃ¡pido
- **Express.js**: Framework web robusto
- **TypeScript**: Tipagem estÃ¡tica

### AI & ML

- **LangChain**: Framework para LLMs
- **OpenAI**: GPT-4o-mini para conversaÃ§Ã£o
- **Vector Search**: Embeddings para FAQ

### Data & Cache

- **Supabase**: PostgreSQL + Auth + Vector
- **Redis**: Cache distribuÃ­do
- **Moment.js**: ManipulaÃ§Ã£o de datas

### Validation & Security

- **Zod**: ValidaÃ§Ã£o de schemas
- **Helmet**: Security headers
- **Express Rate Limit**: Rate limiting
- **CORS**: Cross-origin requests

## âœ… Pontos Fortes da Arquitetura

### Excelentes PrÃ¡ticas

1. **SeparaÃ§Ã£o de responsabilidades** muito clara
2. **Type safety** em toda a aplicaÃ§Ã£o
3. **Error handling** robusto e consistente
4. **Logging estruturado** com Winston
5. **ConfiguraÃ§Ã£o centralizada** com validaÃ§Ã£o
6. **Middleware modular** e reutilizÃ¡vel
7. **Repository pattern** bem implementado
8. **Singleton pattern** para serviÃ§os
9. **ValidaÃ§Ã£o de entrada** em todas as camadas
10. **Cache strategy** inteligente (Redis + DB)

### Arquitetura EscalÃ¡vel

- **Modular**: FÃ¡cil adicionar novos agentes
- **Stateless**: Servidores podem ser replicados
- **Cache distribuÃ­do**: Redis para performance
- **Database otimizada**: Supabase com Ã­ndices

### Manutenibilidade

- **CÃ³digo limpo**: ESLint + Prettier
- **DocumentaÃ§Ã£o**: README detalhado
- **Scripts**: AutomaÃ§Ã£o de tarefas
- **TypeScript**: IntelliSense e refactoring

## ğŸ“Š Endpoints da API

### Assistant Endpoints

- `POST /api/assistant/message` - Processar mensagem direta
- `POST /api/assistant/webhook` - Webhook (replica n8n)
- `GET /api/assistant/health` - Health check

### Health Check

- `GET /health` - Health check geral
- `GET /api/health` - Health check da API

## ğŸ”§ Scripts DisponÃ­veis

```bash
# Desenvolvimento
bun run dev          # Servidor com hot reload
bun run start        # Servidor de produÃ§Ã£o

# Qualidade de cÃ³digo
bun run lint         # Verificar problemas ESLint
bun run lint:fix     # Corrigir problemas automaticamente
bun run format       # Formatar cÃ³digo com Prettier
bun run type-check   # Verificar tipos TypeScript
bun run check        # VerificaÃ§Ã£o completa (tipos + lint)

# UtilitÃ¡rios
bun run populate-faq # Popular base de conhecimento FAQ
```

## ğŸ“ˆ Status do Projeto

### âœ… Completo

- [x] Infraestrutura base (configuraÃ§Ãµes, utils, middleware)
- [x] Assistant Agent funcional com tools programÃ¡ticas
- [x] Sistema de memÃ³ria hÃ­brido (Redis + Supabase)
- [x] Gerenciamento de sessÃµes
- [x] Sistema de webhooks (replicando fluxo n8n)
- [x] RepositÃ³rios para banco de dados
- [x] Sistema de logging e monitoramento
- [x] Linting e formataÃ§Ã£o automÃ¡tica
- [x] Sistema de busca vetorial (FAQ)

### ğŸš§ Em Desenvolvimento

- [ ] Testes automatizados
- [ ] ContainerizaÃ§Ã£o
- [ ] Monitoramento avanÃ§ado

### ğŸ“‹ Roadmap

- [ ] CI/CD pipeline
- [ ] Production deployment
- [ ] API documentation (OpenAPI)
- [ ] Performance optimization

## ğŸ¯ ConclusÃ£o

A arquitetura estÃ¡ **muito bem estruturada** e segue as melhores prÃ¡ticas da indÃºstria. O projeto demonstra excelente separaÃ§Ã£o de responsabilidades, cÃ³digo limpo e maintÃ­vel, type safety robusto, error handling consistente e arquitetura escalÃ¡vel.

As principais melhorias seriam adicionar **testes automatizados** e **containerizaÃ§Ã£o** para completar o ciclo de desenvolvimento profissional. O sistema estÃ¡ pronto para produÃ§Ã£o com algumas otimizaÃ§Ãµes adicionais.

---

_Este documento deve ser atualizado sempre que houver mudanÃ§as significativas na arquitetura do projeto._

# ğŸ—ï¸ Arquitetura do Projeto - Pare Azul API Intelligence

## ğŸ“‹ Resumo Executivo

Este documento descreve a arquitetura completa do sistema de assistente IA conversacional para o Pare Azul. O projeto segue padrÃµes de Clean Architecture + Domain-Driven Design com excelente separaÃ§Ã£o de responsabilidades e type safety robusto.

## ğŸ¯ PadrÃ£o Arquitetural

- **Clean Architecture + Domain-Driven Design**
- **SeparaÃ§Ã£o clara de camadas** (Controllers â†’ Services â†’ Repositories)
- **InversÃ£o de dependÃªncias** bem implementada
- **TypeScript** com tipagem forte em toda a aplicaÃ§Ã£o
- **Modularidade** excelente com responsabilidades bem definidas

## ğŸ“ Estrutura de DiretÃ³rios

```
src/
â”œâ”€â”€ ğŸ¤– agents/                  # Agentes IA especializados
â”‚   â””â”€â”€ assistant/                      # Agente principal de conversaÃ§Ã£o
â”‚       â”œâ”€â”€ agent.ts                    # ConfiguraÃ§Ã£o do LangChain
â”‚       â”œâ”€â”€ index.ts                    # OrquestraÃ§Ã£o de mensagens
â”‚       â”œâ”€â”€ prompt.ts                   # Sistema de prompts dinÃ¢micos
â”‚       â””â”€â”€ schemas.ts                  # Schemas de validaÃ§Ã£o
â”œâ”€â”€ ğŸ’¼ services/                # LÃ³gica de negÃ³cio
â”‚   â”œâ”€â”€ activation.service.ts           # LÃ³gica de ativaÃ§Ãµes
â”‚   â”œâ”€â”€ memory.service.ts               # Gerenciamento de memÃ³ria
â”‚   â””â”€â”€ session.service.ts              # Gerenciamento de sessÃµes
â”œâ”€â”€ ğŸ—ƒï¸ repositories/            # Acesso a dados (Repository Pattern)
â”‚   â”œâ”€â”€ base.repository.ts              # Repository base
â”‚   â”œâ”€â”€ chat.repository.ts              # SessÃµes de chat
â”‚   â””â”€â”€ message.repository.ts           # Mensagens
â”œâ”€â”€ ğŸ›£ï¸ routes/                  # Roteamento da API
â”‚   â”œâ”€â”€ index.ts                        # Roteamento principal
â”‚   â””â”€â”€ assistant.route.ts              # Rotas do assistente
â”œâ”€â”€ ğŸ® controllers/             # Controladores HTTP
â”‚   â””â”€â”€ assistant.controller.ts         # Controller principal
â”œâ”€â”€ ğŸ›¡ï¸ middleware/              # Middlewares de seguranÃ§a e validaÃ§Ã£o
â”‚   â”œâ”€â”€ auth.middleware.ts              # AutenticaÃ§Ã£o
â”‚   â”œâ”€â”€ validation.middleware.ts        # ValidaÃ§Ã£o Zod
â”‚   â”œâ”€â”€ rate-limit.middleware.ts        # Rate limiting
â”‚   â”œâ”€â”€ security.middleware.ts          # Headers de seguranÃ§a
â”‚   â”œâ”€â”€ cors.middleware.ts              # CORS
â”‚   â””â”€â”€ error-handler.middleware.ts     # Tratamento de erros
â”œâ”€â”€ ğŸ”§ utils/                   # UtilitÃ¡rios e helpers
â”‚   â”œâ”€â”€ logger.util.ts                  # Sistema de logging
â”‚   â”œâ”€â”€ vector-search.util.ts           # Busca vetorial
â”‚   â”œâ”€â”€ validation.util.ts              # UtilitÃ¡rios de validaÃ§Ã£o
â”‚   â”œâ”€â”€ crypto.util.ts                  # Criptografia
â”‚   â”œâ”€â”€ redis.util.ts                   # UtilitÃ¡rios Redis
â”‚   â””â”€â”€ activation.utils.ts             # UtilitÃ¡rios de ativaÃ§Ã£o
â”œâ”€â”€ ğŸ“ types/                   # DefiniÃ§Ãµes TypeScript
â”‚   â”œâ”€â”€ chat.types.ts                   # Tipos de chat
â”‚   â”œâ”€â”€ activation.types.ts             # Tipos de ativaÃ§Ã£o
â”‚   â”œâ”€â”€ vehicle.types.ts                # Tipos de veÃ­culos
â”‚   â”œâ”€â”€ prefecture.types.ts             # Tipos de prefeitura
â”‚   â””â”€â”€ session.types.ts                # Tipos de sessÃ£o
â”œâ”€â”€ âš™ï¸ config/                  # ConfiguraÃ§Ãµes do sistema
â”‚   â”œâ”€â”€ environment.config.ts           # VariÃ¡veis de ambiente
â”‚   â”œâ”€â”€ database.config.ts              # ConfiguraÃ§Ã£o Supabase
â”‚   â””â”€â”€ redis.config.ts                 # ConfiguraÃ§Ã£o Redis
â”œâ”€â”€ ğŸ› ï¸ tools/                   # Tools do LangChain
â”‚   â”œâ”€â”€ index.ts                        # AgregaÃ§Ã£o de tools
â”‚   â”œâ”€â”€ activation.tools.ts             # Tools de ativaÃ§Ã£o
â”‚   â”œâ”€â”€ database.tool.ts                # Tools de banco
â”‚   â””â”€â”€ faq.tool.ts                     # Tool de FAQ
â”œâ”€â”€ ğŸ“Š api/                     # IntegraÃ§Ãµes com APIs externas
â”‚   â”œâ”€â”€ activation.api.ts               # API de ativaÃ§Ãµes
â”‚   â”œâ”€â”€ vehicle.api.ts                  # API de veÃ­culos
â”‚   â””â”€â”€ prefecture.api.ts               # API de prefeitura
â”œâ”€â”€ âœ… validators/              # Schemas de validaÃ§Ã£o Zod
â”‚   â”œâ”€â”€ activation.validator.ts         # ValidaÃ§Ã£o de ativaÃ§Ãµes
â”‚   â”œâ”€â”€ user.validator.ts               # ValidaÃ§Ã£o de usuÃ¡rios
â”‚   â”œâ”€â”€ vehicle.validator.ts            # ValidaÃ§Ã£o de veÃ­culos
â”‚   â”œâ”€â”€ prefecture.validator.ts         # ValidaÃ§Ã£o de prefeitura
â”‚   â””â”€â”€ notification.validator.ts       # ValidaÃ§Ã£o de notificaÃ§Ãµes
â””â”€â”€ ğŸ“œ scripts/                 # Scripts utilitÃ¡rios
    â”œâ”€â”€ populate-faq.ts                 # PopulaÃ§Ã£o do FAQ
    â””â”€â”€ faq-data.ts                     # Dados do FAQ
```

## ğŸ”„ Fluxo de ExecuÃ§Ã£o

### 1. Entrada da RequisiÃ§Ã£o

```
HTTP Request â†’ Express Router â†’ Middleware Stack â†’ Controller
```

### 2. Processamento Principal

```
Controller â†’ Agent Index â†’ Session Service â†’ Memory Service â†’ AI Agent
```

### 3. ExecuÃ§Ã£o do Agente IA

```
AI Agent â†’ LangChain â†’ Tools â†’ External APIs â†’ Response
```

### 4. PersistÃªncia e Cache

```
Memory Service â†’ Redis (Cache) + Supabase (Persistence)
```

## ğŸ› ï¸ Sistema de Tools

### Estrutura das Tools

- **LangChain DynamicStructuredTool**: PadrÃ£o consistente
- **Zod Schemas**: ValidaÃ§Ã£o de entrada tipada
- **SeparaÃ§Ã£o por domÃ­nio**: Activation, Database, FAQ
- **Error Handling**: Tratamento robusto de erros

### Tools DisponÃ­veis

1. **`faq_search`**: Busca vetorial no conhecimento
2. **`get_user_info`**: InformaÃ§Ãµes do usuÃ¡rio
3. **`get_message_history`**: HistÃ³rico de conversas
4. **`get_session_status`**: Status da sessÃ£o
5. **`checkVehicleCurrentActivations`**: Verificar ativaÃ§Ãµes
6. **`registerVehicleActivation`**: Registrar ativaÃ§Ãµes

## ğŸ’¼ Camada de ServiÃ§os

### MemoryService

- **Responsabilidade**: Gerenciamento de cache e buffer de memÃ³ria
- **Tecnologias**: Redis + Supabase
- **PadrÃµes**: Singleton, Cache-Aside Pattern

### SessionService

- **Responsabilidade**: Gerenciamento do ciclo de vida das sessÃµes
- **LÃ³gica**: ReplicaÃ§Ã£o do fluxo n8n
- **Features**: Auto-inativaÃ§Ã£o, sessÃµes ativas Ãºnicas

### ActivationService

- **Responsabilidade**: LÃ³gica de negÃ³cio para ativaÃ§Ãµes de veÃ­culos
- **IntegraÃ§Ãµes**: APIs externas do Pareazul
- **ValidaÃ§Ãµes**: Regras de negÃ³cio complexas

## ğŸ” Sistema de ValidaÃ§Ã£o e AutenticaÃ§Ã£o

### ValidaÃ§Ã£o (Zod)

- **Schemas centralizados** em `validators/`
- **ValidaÃ§Ã£o em tempo de execuÃ§Ã£o**
- **Type safety** automÃ¡tico
- **Mensagens de erro** padronizadas

### AutenticaÃ§Ã£o

- **HeaderAuth** compatÃ­vel com n8n
- **Middleware flexÃ­vel** com configuraÃ§Ãµes
- **Suporte a Bearer tokens**
- **ValidaÃ§Ã£o opcional/obrigatÃ³ria**

### Middleware Stack

1. **CORS** â†’ **Security** â†’ **Rate Limiting** â†’ **Auth** â†’ **Validation** â†’ **Controller**

## ğŸ§  Sistema de MemÃ³ria HÃ­brida

### Redis (Cache Layer)

- **Session Cache**: Metadados de sessÃ£o
- **Memory Buffer**: Mensagens recentes
- **TTL configurÃ¡vel**: 6 horas padrÃ£o
- **Fallback graceful**: Continua funcionando sem Redis

### Supabase (Persistence Layer)

- **Chat Sessions**: SessÃµes persistentes
- **Messages**: HistÃ³rico completo
- **Vector Search**: FAQ com embeddings
- **Admin Client**: OperaÃ§Ãµes privilegiadas

## ğŸ¤– ImplementaÃ§Ã£o do Agente IA

### LangChain Integration

- **OpenAI GPT-4o-mini**: Modelo principal
- **Temperature 0.3**: Respostas balanceadas
- **Max Iterations 12**: Previne loops infinitos
- **Early Stopping**: OtimizaÃ§Ã£o de performance

### Prompt Engineering

- **Sistema de prompt dinÃ¢mico** baseado no payload
- **InstruÃ§Ãµes claras** para uso das tools
- **Contexto de sessÃ£o** preservado
- **Exemplos prÃ¡ticos** de interaÃ§Ã£o

### Tool Integration

- **SeleÃ§Ã£o automÃ¡tica** de tools baseada no contexto
- **ValidaÃ§Ã£o de entrada** antes da execuÃ§Ã£o
- **Error handling** robusto
- **Logging detalhado** para debugging

## ğŸ› ï¸ Tecnologias e DependÃªncias

### Runtime & Framework

- **Bun**: Runtime moderno e rÃ¡pido
- **Express.js**: Framework web robusto
- **TypeScript**: Tipagem estÃ¡tica

### AI & ML

- **LangChain**: Framework para LLMs
- **OpenAI**: GPT-4o-mini para conversaÃ§Ã£o
- **Vector Search**: Embeddings para FAQ

### Data & Cache

- **Supabase**: PostgreSQL + Auth + Vector
- **Redis**: Cache distribuÃ­do
- **Moment.js**: ManipulaÃ§Ã£o de datas

### Validation & Security

- **Zod**: ValidaÃ§Ã£o de schemas
- **Helmet**: Security headers
- **Express Rate Limit**: Rate limiting
- **CORS**: Cross-origin requests

## âœ… Pontos Fortes da Arquitetura

### Excelentes PrÃ¡ticas

1. **SeparaÃ§Ã£o de responsabilidades** muito clara
2. **Type safety** em toda a aplicaÃ§Ã£o
3. **Error handling** robusto e consistente
4. **Logging estruturado** com Winston
5. **ConfiguraÃ§Ã£o centralizada** com validaÃ§Ã£o
6. **Middleware modular** e reutilizÃ¡vel
7. **Repository pattern** bem implementado
8. **Singleton pattern** para serviÃ§os
9. **ValidaÃ§Ã£o de entrada** em todas as camadas
10. **Cache strategy** inteligente (Redis + DB)

### Arquitetura EscalÃ¡vel

- **Modular**: FÃ¡cil adicionar novos agentes
- **Stateless**: Servidores podem ser replicados
- **Cache distribuÃ­do**: Redis para performance
- **Database otimizada**: Supabase com Ã­ndices

### Manutenibilidade

- **CÃ³digo limpo**: ESLint + Prettier
- **DocumentaÃ§Ã£o**: README detalhado
- **Scripts**: AutomaÃ§Ã£o de tarefas
- **TypeScript**: IntelliSense e refactoring

## ğŸ“Š Endpoints da API

### Assistant Endpoints

- `POST /api/assistant/message` - Processar mensagem direta
- `POST /api/assistant/webhook` - Webhook (replica n8n)
- `GET /api/assistant/health` - Health check

### Health Check

- `GET /health` - Health check geral
- `GET /api/health` - Health check da API

## ğŸ”§ Scripts DisponÃ­veis

```bash
# Desenvolvimento
bun run dev          # Servidor com hot reload
bun run start        # Servidor de produÃ§Ã£o

# Qualidade de cÃ³digo
bun run lint         # Verificar problemas ESLint
bun run lint:fix     # Corrigir problemas automaticamente
bun run format       # Formatar cÃ³digo com Prettier
bun run type-check   # Verificar tipos TypeScript
bun run check        # VerificaÃ§Ã£o completa (tipos + lint)

# UtilitÃ¡rios
bun run populate-faq # Popular base de conhecimento FAQ
```

## ğŸ“ˆ Status do Projeto

### âœ… Completo

- [x] Infraestrutura base (configuraÃ§Ãµes, utils, middleware)
- [x] Assistant Agent funcional com tools programÃ¡ticas
- [x] Sistema de memÃ³ria hÃ­brido (Redis + Supabase)
- [x] Gerenciamento de sessÃµes
- [x] Sistema de webhooks (replicando fluxo n8n)
- [x] RepositÃ³rios para banco de dados
- [x] Sistema de logging e monitoramento
- [x] Linting e formataÃ§Ã£o automÃ¡tica
- [x] Sistema de busca vetorial (FAQ)

### ğŸš§ Em Desenvolvimento

- [ ] Testes automatizados
- [ ] ContainerizaÃ§Ã£o
- [ ] Monitoramento avanÃ§ado

### ğŸ“‹ Roadmap

- [ ] CI/CD pipeline
- [ ] Production deployment
- [ ] API documentation (OpenAPI)
- [ ] Performance optimization

## ğŸ¯ ConclusÃ£o

A arquitetura estÃ¡ **muito bem estruturada** e segue as melhores prÃ¡ticas da indÃºstria. O projeto demonstra excelente separaÃ§Ã£o de responsabilidades, cÃ³digo limpo e maintÃ­vel, type safety robusto, error handling consistente e arquitetura escalÃ¡vel.

As principais melhorias seriam adicionar **testes automatizados** e **containerizaÃ§Ã£o** para completar o ciclo de desenvolvimento profissional. O sistema estÃ¡ pronto para produÃ§Ã£o com algumas otimizaÃ§Ãµes adicionais.

---

_Este documento deve ser atualizado sempre que houver mudanÃ§as significativas na arquitetura do projeto._
